<!DOCTYPE HTML>

<html lang="pl">

<head>
    <meta charset="utf-8">
    <title>Attack of the Clones</title>
    <meta name="description" content="slider with pure js">
    <meta name="author" content="Mariusz Najwer">
    <script src="https://kit.fontawesome.com/084a192b8b.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
</head>

<body>
    <div id="clones">
        <h1>Attack of the Clones</h1>
        <div id="counter">
            <p>Number of Clones</p>
            <input id="howManyClonesOnPage" value=1>
        </div>
        <div id="counterNext">
            <p>Type Number Of Clones</p>
            <input id="howManyClones" value=1>
        </div>
        <div id="stormtrooper[0]">
            <p id="stormtrooper-name[0]">Name Clone 0</p>
            <input id="stormtrooper-name-input[0]">
            <button id="stormtroope-remove[0]">Remove</button>
        </div>
    </div>
    <button id="stormtroope-add">Add</button>
</body>
<!-- https://javascript.info/modifying-document -->
<script>
    var patternNumberWithSquareBrackets = /\[[0-9]+\]/g //[number]
    var patternNumber = /[0-9]+/g //[number]

    init();

    function init() {
        document.getElementById("counter").style.display = "none"
        document.getElementById("stormtroope-remove[0]").style.display = "none";
        document.getElementById("stormtroope-remove[0]").addEventListener("click", removeStormtrooper);
        document.getElementById("stormtrooper-name-input[0]").addEventListener('change', check)
        document.getElementById("howManyClones").addEventListener('change', addManyClones)

        document.getElementById("stormtroope-add").addEventListener("click", cloneStormtrooper);
    }

    function addManyClones() {
        let clonesOnPage = document.getElementById("howManyClonesOnPage").value;
        if (Number(document.getElementById("howManyClones").value) <= 0) {
            document.getElementById("howManyClones").value = 1
        } 

        if (Number(document.getElementById("howManyClones").value) > 20) {
            document.getElementById("howManyClones").value = 1
        } 
        
        let clonesOnPageAfter = Number(document.getElementById("howManyClones").value) - Number(clonesOnPage);      
        if (clonesOnPageAfter > 0) {
            for (let i = 0; i < clonesOnPageAfter; i++) {
                cloneStormtrooper()
            }
            document.getElementById("howManyClones").value = document.getElementById("howManyClonesOnPage").value;
        } 
        
        if (clonesOnPageAfter < 0) {
            removeSomeStormtroopers(clonesOnPageAfter*(-1))
        }
            
    }

    function changeCloneId(element, newId) {
        element.id = element.id.replace(patternNumberWithSquareBrackets, "[" + newId + "]")
        element.querySelectorAll("*").forEach(v => {
            v.id = v.id.replace(patternNumberWithSquareBrackets, "[" + newId + "]")
            v.innerHTML = v.innerHTML.replace(patternNumber, newId)
        })
        element.querySelectorAll("input").forEach(v => {
            v.value = ''
            v.addEventListener('change', check)
        })
    }

    function cloneStormtrooper () {
        let original = document.getElementById("stormtrooper[0]");
        let origin = document.getElementById("clones");
        let clonesOnPage = document.getElementById("howManyClonesOnPage").value++;
        document.getElementById("howManyClones").value++;

        let clone = original.cloneNode(true);
        changeCloneId(clone, clonesOnPage);
        origin.append(clone);

        origin.querySelectorAll("[id^='stormtroope-remove']").forEach(v => {
            v.style.display = "inline-block";
            v.addEventListener("click", removeStormtrooper);
        })
    }

    function removeSomeStormtroopers(numberOfClones) {
        let clonesOnPage = document.getElementById("howManyClonesOnPage").value
        for (let i = clonesOnPage-1; i > clonesOnPage-numberOfClones-1; i--) {
            let element = document.getElementById("stormtrooper[" + i + "]");
            element.remove();
        }
        clonesOnPage = clonesOnPage - numberOfClones;
        document.getElementById("howManyClonesOnPage").value = clonesOnPage
        if (clonesOnPage == 1)
            document.getElementById("stormtroope-remove[0]").style.display = "none"; 
    }

    function removeStormtrooper() {
        let idToRemove = this.id.match(patternNumber)
        let element = document.getElementById("stormtrooper["+idToRemove+"]");
        let clonesOnPage = --document.getElementById("howManyClonesOnPage").value;
        document.getElementById("howManyClones").value--;
        element.remove()
        for (let i = Number(idToRemove)+1; i <= clonesOnPage; i++) {
            element = document.getElementById("stormtrooper[" + i + "]");
            element.id = element.id.replace(patternNumberWithSquareBrackets, "[" + (i - 1) + "]")
            element.querySelectorAll("*").forEach(v => {
                v.id = v.id.replace(patternNumberWithSquareBrackets, "[" + (i-1) + "]")
                v.innerHTML = v.innerHTML.replace(patternNumber, (i-1))
            })
        }
        if (clonesOnPage == 1)
           document.getElementById("stormtroope-remove[0]").style.display = "none"; 
    }

    function check() {
    //    console.log(this.id)
    }

</script>

</html>